<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of test_finite_horizon_hjb_backward_euler</title>
  <meta name="keywords" content="test_finite_horizon_hjb_backward_euler">
  <meta name="description" content="Test finite horizon hjb, backward euler">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html test -->
<h1>test_finite_horizon_hjb_backward_euler
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Test finite horizon hjb, backward euler</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Test finite horizon hjb, backward euler
 June 20, 2017</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../m2html/@template/set.html" class="code" title="function tpl = set(tpl,action,varargin)">set</a>	TEMPLATE/SET Edit data stored in a Template object</li><li><a href="../src/DiagKTensor.html" class="code" title="function [tens] = DiagKTensor(vec)">DiagKTensor</a>	DIAGKTENSOR Diagonalize a series of vectors in each dimension to a</li><li><a href="../src/EvalT.html" class="code" title="function [y] = EvalT(tens,x,grid)">EvalT</a>	EVALT evaluates a ktensor (function) at an individual point</li><li><a href="../src/SRMultV.html" class="code" title="function res = SRMultV(A,F)">SRMultV</a>	SRMULTV multiplies a ktensor operators A with a ktensor function F. The</li><li><a href="../src/als2.html" class="code" title="function [F, err, iter, e_list, t_step, illcond, noreduce] = als2(op,varargin)">als2</a>	ALS code to perform the ALS algorithm as described in Beylkin</li><li><a href="../src/cp_als.html" class="code" title="function [P,Uinit,output] = cp_als(X,R,varargin)">cp_als</a>	CP_ALS Compute a CP decomposition of any type of tensor.</li><li><a href="../src/ctdlab/fnorm.html" class="code" title="function nrm = fnorm(A)">fnorm</a>	Frobenius norm of ktensor.</li><li><a href="../src/ctdlab/tenid.html" class="code" title="function [Y,err,svCell] = tenid(X,tol,k0,kmax,nrmtype,delta,Xnorm,vb)">tenid</a>	Tensor ID.</li><li><a href="../src/fcell2ftens.html" class="code" title="function [fTens] = fcell2ftens(fcell,grid)">fcell2ftens</a>	FUNC2TENS Creates a function in ktensor form from cell array</li><li><a href="../src/fsym2fcell.html" class="code" title="function [fcell] = fsym2fcell(fsym,x)">fsym2fcell</a>	FSYM2FCELL Creates a function in cell array representation from symbolic</li><li><a href="../src/make_bc_sca.html" class="code" title="function [bsca, regsca] = make_bc_sca(op,bcon,region,regval,als_options,fd1,grid,x,n)">make_bc_sca</a>	MAKE_BC_SCA creates scalings for the boundary condition and goal region</li><li><a href="../src/make_bc_sca_var.html" class="code" title="function [bsca, regsca] = make_bc_sca_var(A,grid,region,bcon)">make_bc_sca_var</a>	MAKE_BC_SCA_VAR creates scalings for the boundary condition and goal</li><li><a href="../src/makebcforward.html" class="code" title="function [bc] = makebcforward(bcon,n)">makebcforward</a>	MAKEBC modifies the ktensor to incooporate boundary conditions.</li><li><a href="../src/makebcopforward.html" class="code" title="function [op] = makebcopforward(op,bcon,n)">makebcopforward</a>	MAKEBCOP modifies the operator to incooporate boundary conditions.</li><li><a href="../src/makediffop.html" class="code" title="function [D,D2,fd1,fd2] = makediffop(grid,n,h,ord_of_acc,bcon,region)">makediffop</a>	MAKEDIFFOP creates differentiation operators in ktensor form and</li><li><a href="../src/makefuncdyn.html" class="code" title="function [fFunc,GFunc,BFunc,noise_covFunc,qFunc,RFunc] = makefuncdyn(f,G,B,noise_cov,q,R,x)">makefuncdyn</a>	MAKEFUNCDYN creates MATLAB functions of symbolic functions, given below.</li><li><a href="../src/makeop.html" class="code" title="function [op,conv,diff] = makeop(fTens,BTens,noise_covTens,qTens,D,D2,D4,lambda)">makeop</a>	MAKEOP creates the operator of the linear HJB equation.</li><li><a href="../src/maketensdyn.html" class="code" title="function [fTens,GTens,BTens,noise_covTens,qTens,RTens] = maketensdyn(f,G,B,noise_cov,q,R,x,grid)">maketensdyn</a>	MAKETENSDYN creates ktensor representation of symbolic functions, given below.</li><li><a href="../src/oneTens.html" class="code" title="function idTens = oneTens(d, n)">oneTens</a>	Create a d dimensional all ones tensor of size n</li><li><a href="../src/plot2Dslice.html" class="code" title="function [handleOutput] = plot2Dslice(F,slices_dim,coordinates,gridT, handleInput,lambda,plotType)">plot2Dslice</a>	Inputs:</li><li><a href="../src/sim_finite_run.html" class="code" title="function sim_finite_run(sim_config,sim_data,saveplots,savedata,run,save_folder)">sim_finite_run</a>	SIMULATION simulates trajectories starting from x0_list using results</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Test finite horizon hjb, backward euler</span>
0002 <span class="comment">% June 20, 2017</span>
0003 
0004 <span class="comment">% Note:</span>
0005 <span class="comment">% - Spectral work with backward euler, but in 2D ALS can be ill-conditioned</span>
0006 <span class="comment">% - Domain needs to be really large to work properly for both finite</span>
0007 <span class="comment">% difference and spectral</span>
0008 
0009 addpath(genpath(<span class="string">'../src'</span>));
0010 clear all
0011 
0012 <span class="comment">%%</span>
0013 run = 8;
0014 dirpath = [<span class="string">'./test_run/test_finite_horizon_hjb_backward_euler/run_'</span>,num2str(run),<span class="string">'/'</span>];
0015 <span class="keyword">if</span> 7~=exist(dirpath,<span class="string">'dir'</span>) 
0016     mkdir(dirpath); 
0017 <span class="keyword">end</span>
0018 diary([dirpath,<span class="string">'run_'</span>,num2str(run),<span class="string">'output'</span>])
0019 fprintf(<span class="string">'--------------------- New Run --------------------- \n\n'</span>)
0020 disp(datetime)
0021 
0022 start_whole = tic;
0023 
0024 <span class="comment">%% Initialization</span>
0025 
0026 d = 2;
0027 x = sym(<span class="string">'x'</span>,[d,1]); <span class="comment">%do not change</span>
0028 n = [50;103];<span class="comment">%155; 153; 161; 165;];</span>
0029 
0030 h = 0.001;<span class="comment">%pi/(2*n); % time step size</span>
0031 tend = 5;
0032 tt = 0:h:tend;
0033 
0034 bdim = [-pi pi-(2*pi/n(1));-10 10;];<span class="comment">%[-5 5 ; -5 5 ; -5 5; -5 5; -5 5; -5 5];%[-pi pi; -10 10];</span>
0035 bcon = {{<span class="string">'p'</span>},{<span class="string">'d'</span>,0,0}}; <span class="comment">%{{'d',0,0},{'d', 0, 0}};</span>
0036 <span class="comment">% bcon = { {'d',0,0} , {'d',0,0}, {'d',0,0}, {'d',0,0}, {'d',0,0}, {'d',0,0} }; %{ {'p'},{'d', 0, 0}};</span>
0037 bsca = [1 1; 1 1; 1 1]; <span class="comment">%no manual scaling</span>
0038 region = [];
0039 regval = 1;
0040 regsca = [];
0041 sca_ver = 1;
0042 
0043 tol_err_op = 1e-6;
0044 tol_err = 1e-9;
0045 als_options = {100,20,<span class="string">'average'</span>,1e-7,1e-12,0.01,15};
0046 als_variant = []; <span class="comment">%{10,50};</span>
0047 debugging = 0;
0048 
0049 fprintf([<span class="string">'Starting run '</span>,num2str(run),<span class="string">' with main_run \n'</span>])
0050 
0051 <span class="comment">%% Define dynamics</span>
0052 
0053 <span class="comment">% Linear system</span>
0054 <span class="comment">% AA = [</span>
0055 <span class="comment">%    -1.2488    0.5746    1.0903    1.3607    0.3494   -0.6191;</span>
0056 <span class="comment">%    -0.0884   -1.3094   -0.8831    1.6346    0.4975   -0.3493;</span>
0057 <span class="comment">%     1.4093    0.2445   -0.6672    0.0464    0.8427    1.4036;</span>
0058 <span class="comment">%     0.6186   -0.1546    1.5360   -0.1142    0.1509    0.1451;</span>
0059 <span class="comment">%     0.3676    0.0292   -1.1329   -0.4568   -0.8125   -1.5609;</span>
0060 <span class="comment">%     0.9457   -1.6709   -0.3731   -0.0540   -0.6918    2.0096];%randn(d,d);</span>
0061 <span class="comment">% BB = eye(d,2);</span>
0062 <span class="comment">% QQ = diag(ones(d,1));</span>
0063 <span class="comment">% PP = care(AA,BB,QQ);</span>
0064 <span class="comment">% B = BB;</span>
0065 <span class="comment">% G = B;</span>
0066 <span class="comment">% f = AA*x;</span>
0067 <span class="comment">% noise_cov = diag(ones(2,1));</span>
0068 <span class="comment">% q = x'*QQ*x;</span>
0069 <span class="comment">% R = diag(ones(2,1));</span>
0070 <span class="comment">% lambda = 1;%noise_cov*R;</span>
0071 
0072 <span class="comment">% Linear system</span>
0073 <span class="comment">% AA = 0.1*randn(d,d);</span>
0074 <span class="comment">% BB = ones(d,2);</span>
0075 <span class="comment">% QQ = diag(ones(d,1));</span>
0076 <span class="comment">% RR = 1/2*diag(ones(1,2));</span>
0077 <span class="comment">% PP = care(AA,BB,QQ,RR);</span>
0078 <span class="comment">% B = BB;</span>
0079 <span class="comment">% G = B;</span>
0080 <span class="comment">% f = AA*x;</span>
0081 <span class="comment">% noise_cov = diag(ones(1,2));</span>
0082 <span class="comment">% q = x'*QQ*x;</span>
0083 <span class="comment">% R = RR;</span>
0084 <span class="comment">% lambda = 1;%noise_cov*R;</span>
0085 
0086 
0087 <span class="comment">% Smooth 2D</span>
0088 <span class="comment">% f = 2*[x(1)^5-x(1)^3-x(1)+x(1)*x(2)^4; x(2)^5-x(2)^3-x(2)+x(2)*x(1)^4];</span>
0089 <span class="comment">% G = [x(1) 0; 0 x(2)];</span>
0090 <span class="comment">% B = BB;</span>
0091 <span class="comment">% noise_cov = diag([1 1]);</span>
0092 <span class="comment">% q = x'*QQ*x;</span>
0093 <span class="comment">% R = diag([1 1]);</span>
0094 <span class="comment">% lambda = 1;%noise_cov*R;</span>
0095 
0096 <span class="comment">% Simple Pendulum</span>
0097 f1 = sin(x(1));
0098 f = [x(2) ; f1];
0099 G = [0.01 ; 1];
0100 B = G;
0101 noise_cov = 1;
0102 q = 0.1*x(1)^2+0.05*x(2)^2;
0103 R = 0.02;
0104 lambda = noise_cov*R;
0105 
0106 <span class="comment">% Inverted Pendulum</span>
0107 <span class="comment">% m = 2; M = 8; l = .5; g = 9.8; mr = m/(m+M); den = 4/3-mr*cos(x(1))^2;</span>
0108 <span class="comment">% f1 = (g/l)*sin(x(1))/den;</span>
0109 <span class="comment">% f2 = -0.5*mr*x(2)^2*sin(2*x(1))/den;</span>
0110 <span class="comment">% f = [x(2) ; f1+f2];</span>
0111 <span class="comment">% G = [0.01 ; -mr/(m*l)*cos(x(1))/den];</span>
0112 <span class="comment">% B = G;</span>
0113 <span class="comment">% noise_cov = 10*pi;</span>
0114 <span class="comment">% q = 0.1*x(1)^2+0.05*x(2)^2;</span>
0115 <span class="comment">% R = 0.02;</span>
0116 <span class="comment">% lambda = noise_cov*R;</span>
0117 <span class="comment">%</span>
0118 <span class="comment">% % linearized dynamics</span>
0119 <span class="comment">% AA = [0 1; (g/l)/(4/3-mr) 0];%randn(d,d);%</span>
0120 <span class="comment">% BB = [0.01; -mr/(m*l)/(4/3-mr)]; %eye(d);%</span>
0121 <span class="comment">% QQ = diag([0.1 0.05]);</span>
0122 <span class="comment">% PP = care(AA,BB,QQ);</span>
0123 
0124 <span class="comment">% VTOL</span>
0125 <span class="comment">% g = 9.8; eps = 0.01;</span>
0126 <span class="comment">% f = [x(2); 0; x(4); -g; x(6); 0];</span>
0127 <span class="comment">% G = [0 0; -sin(x(5)) eps*cos(x(5)); 0 0; cos(x(5)) eps*sin(x(5)); 0 0; 0 1];</span>
0128 <span class="comment">% B = G;</span>
0129 <span class="comment">% noise_cov = diag([3 3]);</span>
0130 <span class="comment">% q = x'*x;</span>
0131 <span class="comment">% R = diag([2 2]);</span>
0132 <span class="comment">% lambda = 6;%noise_cov*R;</span>
0133 
0134 <span class="comment">% linearized dynamics</span>
0135 <span class="comment">% AA = [0 1 0 0 0 0; 0 0 0 0 0 0; 0 0 0 1 0 0; 0 0 0 0 0 0; 0 0 0 0 0 1; 0 0 0 0 0 0];%randn(d,d);%</span>
0136 <span class="comment">% BB = [0 0; 0 eps; 0 0; 1 0; 0 0; 0 1]; %eye(d);%</span>
0137 <span class="comment">% QQ = diag([1 1 1 1 1 1]);</span>
0138 <span class="comment">% PP = 10*diag([1 1 1 1 1 1]); %care(AA,BB,QQ);</span>
0139 
0140 <span class="comment">%% Calculate differentiation operators and finite difference matrices</span>
0141 
0142 fprintf(<span class="string">'Creating differential operators ...\n'</span>);
0143 start_diff = tic;
0144 
0145 <span class="keyword">for</span> i=1:d
0146     gridT{i} = linspace(bdim(i,1),bdim(i,2),n(i))';
0147     nd(i) = n(i);
0148     dxd(i) = abs(gridT{i}(2) - gridT{i}(1));
0149     acc(:,i) = [2,2]';
0150 <span class="keyword">end</span>
0151 
0152 [D,D2,fd1,fd2] = <a href="../src/makediffop.html" class="code" title="function [D,D2,fd1,fd2] = makediffop(grid,n,h,ord_of_acc,bcon,region)">makediffop</a>(gridT,nd,dxd,acc,bcon,region);
0153 
0154 <span class="comment">% [~,gridT,~,D,D2,fd1,fd2] = makediffopspectral(bdim,n,bcon,[0 0]);</span>
0155 toc(start_diff)
0156 end_diff = toc(start_diff);
0157 
0158 <span class="comment">%% Calculate dynamics</span>
0159 fprintf(<span class="string">'Creating dynamics operator ...\n'</span>);
0160 start_dynamics = tic;
0161 [fTens,GTens,BTens,noise_covTens,qTens,RTens] = <a href="../src/maketensdyn.html" class="code" title="function [fTens,GTens,BTens,noise_covTens,qTens,RTens] = maketensdyn(f,G,B,noise_cov,q,R,x,grid)">maketensdyn</a>(f,G,B,noise_cov,q,R,x,gridT);
0162 toc(start_dynamics)
0163 end_dynamics = toc(start_dynamics);
0164 
0165 <span class="comment">%% Calculate operator</span>
0166 fprintf(<span class="string">'Creating PDE operator ...\n'</span>);
0167 start_PDEop = tic;
0168 [op,conv,diff] = <a href="../src/makeop.html" class="code" title="function [op,conv,diff] = makeop(fTens,BTens,noise_covTens,qTens,D,D2,D4,lambda)">makeop</a>(fTens,BTens,noise_covTens,qTens,D,D2,0,lambda);
0169 op = <a href="../src/DiagKTensor.html" class="code" title="function [tens] = DiagKTensor(vec)">DiagKTensor</a>(<a href="../src/oneTens.html" class="code" title="function idTens = oneTens(d, n)">oneTens</a>(d, n)) + op*h;
0170 <span class="comment">% op = DiagKTensor(oneTens(d, n)) - op*h;</span>
0171 toc(start_PDEop)
0172 end_PDEop = toc(start_PDEop);
0173 
0174 <span class="comment">%% Create boundary conditions</span>
0175 
0176 <span class="comment">% create scaling for bc</span>
0177 <span class="keyword">if</span> isempty(bsca) == 1 || isempty(regsca) == 1
0178     
0179     <span class="keyword">if</span> sca_ver == 1
0180         [bscat, ~] = <a href="../src/make_bc_sca_var.html" class="code" title="function [bsca, regsca] = make_bc_sca_var(A,grid,region,bcon)">make_bc_sca_var</a>(op,gridT,region,bcon);    
0181     <span class="keyword">elseif</span> sca_ver == 2
0182         [bscat, ~] = <a href="../src/make_bc_sca.html" class="code" title="function [bsca, regsca] = make_bc_sca(op,bcon,region,regval,als_options,fd1,grid,x,n)">make_bc_sca</a>(op,bcon,region,regval,als_options,fd1,gridT,x,n);
0183     <span class="keyword">else</span>
0184         error(<span class="string">'wrong specification on boundary scaling'</span>);
0185     <span class="keyword">end</span>
0186 <span class="keyword">end</span>
0187 
0188 <span class="keyword">if</span> isempty(bsca)
0189     bsca = bscat;
0190 <span class="keyword">end</span>
0191 
0192 <span class="comment">% NOTE: This is bad for backward euler. Not if the boundary condition</span>
0193 <span class="comment">% scaling is 1 for Dirichlet BC. For periodic and neumann, need to adjust</span>
0194 <span class="comment">% the boundary of F_all as well.</span>
0195 <span class="comment">% [op] = makebcop(op,bcon,bsca,n,fd1);</span>
0196 [op] = <a href="../src/makebcopforward.html" class="code" title="function [op] = makebcopforward(op,bcon,n)">makebcopforward</a>(op,bcon,n);
0197 <span class="comment">% [op] = makebcopspectral(op,bcon,bsca,n,fd1);</span>
0198 
0199 <span class="comment">%% Create initial conditions</span>
0200 fprintf(<span class="string">'Creating initial conditions ...\n'</span>);
0201 start_PDEinit = tic;
0202 <span class="keyword">if</span> d &lt; 2
0203     <span class="keyword">if</span> d == 2
0204         [gridx, gridy] = meshgrid(gridT{1},gridT{2});
0205         init = reshape(exp(-(sum(([gridx(:) gridy(:)]*PP).*[gridx(:) gridy(:)],2))/lambda),n(2),n(1));
0206 <span class="comment">%         init = exp(-x(1)'*PP(1,1)*x(1)/lambda)*exp(-x(2)'*PP(2,2)*x(2)/lambda);</span>
0207         initTens  = {<a href="../src/cp_als.html" class="code" title="function [P,Uinit,output] = cp_als(X,R,varargin)">cp_als</a>(tensor(init'),10)};
0208     <span class="keyword">elseif</span> d == 1
0209         init = exp(-x(1)'*PP*x(1)/lambda);
0210         initTens  = <a href="../src/fcell2ftens.html" class="code" title="function [fTens] = fcell2ftens(fcell,grid)">fcell2ftens</a>( <a href="../src/fsym2fcell.html" class="code" title="function [fcell] = fsym2fcell(fsym,x)">fsym2fcell</a>(sym(init) ,x), gridT);
0211     <span class="keyword">end</span>
0212     
0213 <span class="keyword">else</span>
0214     U = cell(d,1);
0215     <span class="keyword">for</span> i = 1:d
0216         U{i} = exp(-gridT{i}.^2);
0217     <span class="keyword">end</span>
0218     initTens = {ktensor(U)};
0219 <span class="keyword">end</span>
0220     
0221 toc(start_PDEinit)
0222 end_PDEinit = toc(start_PDEinit);
0223 
0224 <span class="comment">%% Compress operator</span>
0225 
0226 op_uncomp = op; <span class="comment">%save uncompressed op</span>
0227 
0228 fprintf(<span class="string">'Attempt to compress operator, rank(op)=%d\n'</span>, ncomponents(op));
0229 rank_op_uncomp = ncomponents(op);
0230 
0231 start_compress_id = tic;
0232 fprintf(<span class="string">'Target CTD: %d terms above tol\n'</span>, length(find(op.lambda&gt;tol_err_op)));
0233 fprintf(<span class="string">'Running TENID with frobenius norm:\n'</span>)
0234 [op,~] = <a href="../src/ctdlab/tenid.html" class="code" title="function [Y,err,svCell] = tenid(X,tol,k0,kmax,nrmtype,delta,Xnorm,vb)">tenid</a>(op,tol_err_op,1,9,<span class="string">'frob'</span>,[],<a href="../src/ctdlab/fnorm.html" class="code" title="function nrm = fnorm(A)">fnorm</a>(op),0);
0235 op = fixsigns(arrange(op));
0236 compress_time_id = toc(start_compress_id);
0237 fprintf(<span class="string">'Number of components after TENID compression, %d\n'</span>, ncomponents(op));
0238 toc(start_compress_id)
0239 
0240 start_compress = tic;
0241 fprintf(<span class="string">'Running ALS:\n'</span>)
0242 [op, err_op, iter_op, enrich_op, t_step_op, cond_op, noreduce] = <a href="../src/als2.html" class="code" title="function [F, err, iter, e_list, t_step, illcond, noreduce] = als2(op,varargin)">als2</a>(op,tol_err_op);
0243 rank_op_comp = ncomponents(op);
0244 fprintf(<span class="string">'Number of components after ALS compression, %d\n'</span>, ncomponents(op));
0245 compress_time = toc(start_compress);
0246 toc(start_compress)
0247 
0248 <span class="comment">%% Solve system</span>
0249 
0250 disp(<span class="string">'Beginning Solving'</span>);
0251 tic;
0252 start_solve = tic;
0253 
0254 F_all = cell(1,tend+1);
0255 F_all{1} = initTens{1};
0256 
0257 t = 0;
0258 
0259 iter_time = zeros(length(tt),1);
0260 <span class="comment">%%</span>
0261 <span class="keyword">for</span> ind = 2:length(tt)+1
0262     start_iter = tic;
0263 <span class="comment">%     [bc] = makebcbackward(F_all{ind-1},bcon,n);</span>
0264 <span class="comment">%     [F, ~] = als_sys(op,bc,bc,tol_err_op,als_options,debugging, 0);</span>
0265     [bc] = <a href="../src/makebcforward.html" class="code" title="function [bc] = makebcforward(bcon,n)">makebcforward</a>(bcon,n);
0266     F = <a href="../src/SRMultV.html" class="code" title="function res = SRMultV(A,F)">SRMultV</a>(op,F_all{ind-1}) + bc;
0267     
0268     <span class="keyword">if</span> ncomponents(F) &gt; ncomponents(F_all{ind-1})
0269 <span class="comment">%         [F,~] = tenid(F,tol_err_op,1,9,'frob',[],fnorm(F),0);</span>
0270         [F_all{ind}, ~] = <a href="../src/als2.html" class="code" title="function [F, err, iter, e_list, t_step, illcond, noreduce] = als2(op,varargin)">als2</a>(F,tol_err_op);
0271     <span class="keyword">else</span>
0272         F_all{ind} = F;
0273     <span class="keyword">end</span>
0274     iter_time(ind-1) = toc(start_iter);
0275     
0276     <span class="keyword">if</span> mod(ind,20) == 0
0277         fprintf(<span class="string">'Time: %.4fs  Current tensor rank: %d \n'</span>, tt(ind), ncomponents(F_all{ind}))
0278     <span class="keyword">end</span>
0279 <span class="comment">%     if norm(F)/(sum(n)*ncomponents(F)) &lt; tol_err_op</span>
0280 <span class="comment">%         break</span>
0281 <span class="comment">%     end</span>
0282 <span class="keyword">end</span>
0283 
0284 time_solve = toc(start_solve);
0285 toc;
0286 disp(<span class="string">'Solution complete'</span>);
0287 
0288 time_whole = toc(start_whole);
0289 
0290 fprintf([<span class="string">'Run '</span>,num2str(run),<span class="string">' with main_run is complete \n'</span>])
0291 
0292 diary off
0293 
0294 save([dirpath,<span class="string">'run_'</span>,num2str(run),<span class="string">'data'</span>])
0295 
0296 <span class="comment">%% Visualize results</span>
0297 
0298 <span class="comment">%% Dimension = 1</span>
0299 
0300 <span class="keyword">if</span> d == 1
0301 <span class="comment">%% True solution</span>
0302 
0303     ts_grid = csvread([dirpath,<span class="string">'grid.csv'</span>]);
0304     ts_value = csvread([dirpath,<span class="string">'value.csv'</span>]);
0305 
0306 <span class="comment">%% Plot result</span>
0307 
0308     px = zeros(n,length(tt));
0309     <span class="keyword">for</span> k=1:ind-1;<span class="comment">%length(tt)</span>
0310        px(:,k) = double(F_all{k}); 
0311     <span class="keyword">end</span>
0312 
0313     plottend = length(tt)-length(tt)+ind-1;
0314     figure
0315     hold on
0316     surf(gridT{1},tt(end:-1:end-plottend+1),px(:,1:plottend)',<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0317 <span class="comment">%     scatter3(ts_grid(:,1),ts_grid(:,2),ts_value,10,'filled');</span>
0318     zlim([-0.2 1.2])
0319 <span class="comment">%     ylim([2.5 3])</span>
0320     xlabel(<span class="string">'X(m)'</span>)
0321     ylabel(<span class="string">'Time(s)'</span>)
0322     zlabel(<span class="string">'Desirability(x,t)'</span>)
0323     title(<span class="string">'Desirability function evolution'</span>)
0324     colorbar
0325 <span class="keyword">end</span>
0326 
0327 <span class="comment">%% Dimension = 2</span>
0328 
0329 <span class="keyword">if</span> d == 2
0330 <span class="comment">%% True solutions for linear system</span>
0331     
0332 <span class="comment">% AA = eye(d);</span>
0333 <span class="comment">% BB = eye(d);</span>
0334 <span class="comment">% QQ = eye(d);</span>
0335 <span class="comment">% PP = diag([6 6]);</span>
0336 <span class="comment">% noise = diag([1 1]);</span>
0337 <span class="comment">% lambda = 1;</span>
0338 
0339     ts_grid = csvread([dirpath,<span class="string">'grid 2.csv'</span>]);
0340     ts_value = csvread([dirpath,<span class="string">'value 2.csv'</span>]);
0341 
0342 <span class="comment">%% Plot result</span>
0343     figure
0344     ht_pdf = surf(gridT{1},gridT{2},double(F_all{1})');
0345     colorbar;
0346     <span class="comment">%set(h, 'ylim', [0 0.25])</span>
0347 <span class="comment">%     caxis([0 1])</span>
0348     <a href="../m2html/@template/set.html" class="code" title="function tpl = set(tpl,action,varargin)">set</a>(ht_pdf, <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
0349     xlabel(<span class="string">'x'</span>)
0350     ylabel(<span class="string">'y'</span>)
0351     title([<span class="string">'Time = '</span>,num2str(tt(1))]);
0352     axis ([bdim(1,:),bdim(2,:)])
0353     <span class="keyword">for</span> k = 2:1:ind<span class="comment">%length(tt)</span>
0354          <a href="../m2html/@template/set.html" class="code" title="function tpl = set(tpl,action,varargin)">set</a>(ht_pdf, <span class="string">'ZData'</span>, double(F_all{k})' );
0355          title([<span class="string">'Time = '</span>,num2str(tt(k))]);
0356          drawnow
0357          pause(1.0/1000);
0358     <span class="keyword">end</span>
0359     
0360 <span class="comment">%%</span>
0361 <span class="comment">%     timenn = 115;</span>
0362     k = 1;
0363     figure
0364     hold on
0365     surf(gridT{1},gridT{2},double(F_all{1})',<span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
0366 <span class="comment">%     scatter3(ts_grid(1:timenn:end,1),ts_grid(1:timenn:end,2),ts_value(k-1+(1:timenn:end)),10,'filled');</span>
0367     colorbar;
0368     xlabel(<span class="string">'x'</span>)
0369     ylabel(<span class="string">'y'</span>)
0370 <span class="comment">%     xlim([-5 5])</span>
0371 <span class="comment">%     ylim([-5 5])</span>
0372 
0373 <span class="comment">%%</span>
0374     timenn = 115;
0375     figure
0376     ht_true = scatter3(ts_grid(1:timenn:<span class="keyword">end</span>,1),ts_grid(1:timenn:<span class="keyword">end</span>,2),ts_value(1:timenn:end),10,<span class="string">'filled'</span>);
0377     colorbar;
0378     <span class="comment">%set(h, 'ylim', [0 0.25])</span>
0379     caxis([0 1])
0380     xlabel(<span class="string">'x'</span>)
0381     ylabel(<span class="string">'y'</span>)
0382     title([<span class="string">'Time = '</span>,num2str(tt(1))]);
0383     grid on
0384     axis ([bdim(1,:),bdim(2,:)])
0385     grid on
0386     <span class="keyword">for</span> k = 2:1:timenn
0387          <a href="../m2html/@template/set.html" class="code" title="function tpl = set(tpl,action,varargin)">set</a>(ht_true,<span class="string">'ZData'</span>, ts_value(k-1+(1:timenn:end)));
0388          title([<span class="string">'Time = '</span>,num2str(ts_grid(k,3))]);
0389          drawnow
0390          pause(1.0/10);
0391     <span class="keyword">end</span>
0392 
0393 <span class="keyword">end</span>
0394 
0395 <span class="comment">%% Dimension &gt; 2</span>
0396 
0397 <span class="keyword">if</span> d &gt; 2
0398     
0399 <span class="comment">%%</span>
0400     dim_plot = [3 4];
0401 <span class="comment">%     total_plot = factorial(d);</span>
0402 <span class="comment">% %     row = ceil(sqrt(d));</span>
0403 <span class="comment">%     column =</span>
0404     figure
0405 <span class="comment">%     subplot(</span>
0406     coord = ceil(n/2);
0407 <span class="comment">%     coord(4) = ceil(n(4)/2);</span>
0408     <span class="keyword">for</span> k = 1:10:ind-1<span class="comment">%length(tt)</span>
0409          <a href="../src/plot2Dslice.html" class="code" title="function [handleOutput] = plot2Dslice(F,slices_dim,coordinates,gridT, handleInput,lambda,plotType)">plot2Dslice</a>(F_all{k},dim_plot,coord,gridT);
0410          colorbar;
0411          axis ([bdim(dim_plot(1),:),bdim(dim_plot(2),:)])
0412          title([<span class="string">'Time = '</span>,num2str(tt(k))]);
0413 <span class="comment">%          drawnow</span>
0414          caxis([0 1])
0415          zlim([0 1])
0416          pause(1.0/1000);
0417     <span class="keyword">end</span>
0418     
0419 <span class="keyword">end</span>
0420 
0421 
0422 <span class="comment">%% Simulations</span>
0423 
0424 saveplots = 0;
0425 savedata = 0;
0426 <span class="comment">% ninputs = 2;</span>
0427 <span class="comment">% uref = zeros(ninputs,1);</span>
0428 
0429 [fFunc,GFunc,BFunc,noise_covFunc,qFunc,RFunc] = <a href="../src/makefuncdyn.html" class="code" title="function [fFunc,GFunc,BFunc,noise_covFunc,qFunc,RFunc] = makefuncdyn(f,G,B,noise_cov,q,R,x)">makefuncdyn</a>(f1,G,B,noise_cov,q,R,x);
0430 sim_config = {h*(ind-1),h,repmat([1; 0; 0.8; -1.5; 0.1; 0;],1,1),[],[]};
0431 sim_data = {lambda,gridT,R,noise_cov,F_all,uref,D,fFunc,GFunc,BFunc,qFunc,bdim,bcon,region};
0432 
0433 <a href="../src/sim_finite_run.html" class="code" title="function sim_finite_run(sim_config,sim_data,saveplots,savedata,run,save_folder)">sim_finite_run</a>(sim_config,sim_data,saveplots,savedata,run,dirpath)
0434 
0435 <span class="comment">%% LQR</span>
0436 
0437 SS = zeros(d,d,length(tt));
0438 qq = zeros(length(tt),1);
0439 SS(:,:,1) = PP;
0440 qq(1) = 0;
0441 <span class="keyword">for</span> ind = 1:length(tt)-1
0442     SS(:,:,ind+1) = SS(:,:,ind)+(AA'*SS(:,:,ind)+SS(:,:,ind)*AA-2*SS(:,:,ind)*BB/R*BB'*SS(:,:,ind)+QQ)*h;
0443     qq(ind+1) = qq(ind) + trace(SS(:,:,ind)*BB*noise_cov*BB')*h;
0444 <span class="keyword">end</span>
0445 
0446 <span class="comment">%% dimension = 2</span>
0447 <span class="keyword">if</span> d == 2
0448     
0449 <span class="comment">%% Plot result</span>
0450     
0451     [gridx, gridy] = meshgrid(gridT{1},gridT{2});
0452     lqr_values = exp(-(sum(([gridx(:) gridy(:)]*SS(:,:,1)).*[gridx(:) gridy(:)],2)+qq(1))/lambda);
0453     
0454     figure
0455     ht_pdf = surf(gridT{1},gridT{2},reshape(lqr_values,n(2),n(1)));
0456     colorbar;
0457     <span class="comment">%set(h, 'ylim', [0 0.25])</span>
0458 <span class="comment">%     caxis([0 1])</span>
0459     <a href="../m2html/@template/set.html" class="code" title="function tpl = set(tpl,action,varargin)">set</a>(ht_pdf, <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
0460     xlabel(<span class="string">'x'</span>)
0461     ylabel(<span class="string">'y'</span>)
0462     title([<span class="string">'Time = '</span>,num2str(tt(1))]);
0463     axis ([bdim(1,:),bdim(2,:)])
0464     <span class="keyword">for</span> k = 2:10:ind<span class="comment">%length(tt)</span>
0465          lqr_values = exp(-(sum(([gridx(:) gridy(:)]*SS(:,:,ind)).*[gridx(:) gridy(:)],2)+qq(k))/lambda);
0466          <a href="../m2html/@template/set.html" class="code" title="function tpl = set(tpl,action,varargin)">set</a>(ht_pdf, <span class="string">'ZData'</span>, reshape(lqr_values,n(2),n(1)) );
0467          title([<span class="string">'Time = '</span>,num2str(tt(k))]);
0468          drawnow
0469          pause(1.0/1000);
0470     <span class="keyword">end</span>
0471     
0472  <span class="comment">%%</span>
0473     px = zeros(n,length(tt));
0474     <span class="keyword">for</span> k=1:ind-1;<span class="comment">%length(tt)</span>
0475        px(:,k) = exp(-(gridT{1}.*squeeze(SS(:,:,k)).*gridT{1}+qq(k))/lambda); 
0476     <span class="keyword">end</span>
0477 
0478     plottend = length(tt)-length(tt)+ind-1;
0479     figure
0480     hold on
0481     surf(gridT{1},tt(end:-1:end-plottend+1),px(:,1:plottend)',<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0482 <span class="comment">%     scatter3(ts_grid(:,1),ts_grid(:,2),ts_value,10,'filled');</span>
0483     zlim([-0.2 1.2])
0484 <span class="comment">%     ylim([2.5 3])</span>
0485     xlabel(<span class="string">'X(m)'</span>)
0486     ylabel(<span class="string">'Time(s)'</span>)
0487     zlabel(<span class="string">'Desirability(x,t)'</span>)
0488     title(<span class="string">'Desirability function evolution'</span>)
0489     colorbar
0490     
0491     <span class="comment">%%</span>
0492     
0493     ten_ori = zeros(length(tt),1);
0494     <span class="keyword">for</span> k = 1:length(tt)
0495         ten_ori(k) = <a href="../src/EvalT.html" class="code" title="function [y] = EvalT(tens,x,grid)">EvalT</a>(F_all{k},[0,0], gridT);<span class="comment">% max(double(F_all{k}));%</span>
0496     <span class="keyword">end</span>
0497     
0498     figure
0499     plot(tt,[-lambda*log(ten_ori) qq])
0500     
0501     figure
0502     plot(tt,[ten_ori exp(-qq/lambda)])
0503     
0504     figure
0505     plot(tt,(-lambda*log(ten_ori)-qq))
0506     
0507 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 12-Jan-2018 11:28:53 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>